<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Termux原理 | 虚空之地</title><meta name="keywords" content="软件,终端"><meta name="author" content="逯晓零"><meta name="copyright" content="逯晓零"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="寻思了很久，我还是决定写下这篇文章，但这篇文章可能有点杂，看的话希望忍一忍。Termux是一个终端模拟器，让安卓有如同linux一般强大，但“安卓天生是linux”，真正的实现或许并没想象中那么复杂。我们先做一些铺垫吧。 软件是什么在最开始我想说清软件到底是什么？你可能会觉得不就是，windows的exe，安卓的apk，苹果的ipa，linux的(…)…。这样讲好像也没太大问题，exe确实是可执行">
<meta property="og:type" content="article">
<meta property="og:title" content="Termux原理">
<meta property="og:url" content="http://example.com/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="虚空之地">
<meta property="og:description" content="寻思了很久，我还是决定写下这篇文章，但这篇文章可能有点杂，看的话希望忍一忍。Termux是一个终端模拟器，让安卓有如同linux一般强大，但“安卓天生是linux”，真正的实现或许并没想象中那么复杂。我们先做一些铺垫吧。 软件是什么在最开始我想说清软件到底是什么？你可能会觉得不就是，windows的exe，安卓的apk，苹果的ipa，linux的(…)…。这样讲好像也没太大问题，exe确实是可执行">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-12-22T01:01:58.000Z">
<meta property="article:modified_time" content="2022-10-14T23:47:06.308Z">
<meta property="article:author" content="逯晓零">
<meta property="article:tag" content="软件">
<meta property="article:tag" content="终端">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Termux原理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-15 07:47:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/words/"><i class="fa-fw fa fa-snowflake"></i><span> 动态</span></a></div><div class="menus_item"><a class="site-page" href="/articles/"><i class="fa-fw fa fa-book"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/dream/"><i class="fa-fw fa fa-lightbulb"></i><span> 绘梦</span></a></div><div class="menus_item"><a class="site-page" href="/retrieval/"><i class="fa-fw fa fa-search"></i><span> 检索</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">虚空之地</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/words/"><i class="fa-fw fa fa-snowflake"></i><span> 动态</span></a></div><div class="menus_item"><a class="site-page" href="/articles/"><i class="fa-fw fa fa-book"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/dream/"><i class="fa-fw fa fa-lightbulb"></i><span> 绘梦</span></a></div><div class="menus_item"><a class="site-page" href="/retrieval/"><i class="fa-fw fa fa-search"></i><span> 检索</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Termux原理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-22T01:01:58.000Z" title="发表于 2021-12-22 09:01:58">2021-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-14T23:47:06.308Z" title="更新于 2022-10-15 07:47:06">2022-10-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/">计算机</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>寻思了很久，我还是决定写下这篇文章，但这篇文章可能有点杂，看的话希望忍一忍。Termux是一个终端模拟器，让安卓有如同linux一般强大，但“安卓天生是linux”，真正的实现或许并没想象中那么复杂。我们先做一些铺垫吧。</p>
<h1 id="软件是什么"><a href="#软件是什么" class="headerlink" title="软件是什么"></a>软件是什么</h1><p>在最开始我想说清软件到底是什么？你可能会觉得不就是，windows的exe，安卓的apk，苹果的ipa，linux的(…)…。这样讲好像也没太大问题，exe确实是可执行文件，但apk和ipa可是安装包，大部分认识的exe也是安装包所以把它与apk和ipa归为一类也是可以理解的。软件本质上分为两种原生软件和虚拟机上软件，我们稍微来介绍一下吧。</p>
<h2 id="虚拟机上软件"><a href="#虚拟机上软件" class="headerlink" title="虚拟机上软件"></a>虚拟机上软件</h2><p>这种称呼只是作者自己这样叫的，你可别信了。java软件就是这类软件的典型代表，如logisim和java版minecraft。它们的典型特点是我们还必须下载一个运行环境(java的jre)，这实际就是一种虚拟机的思想，通过一层java虚拟机达到在不同平台运行同一软件的效果，实际上基本所有语言都是这样运行的，不限于java，python，lua，C#等，除了少数的C/C++，go，rust等，实际上远古的语言都是后者类型，但后来发现java这种虚拟机上的语言有极大的遍历，流行的就都变成了前者类型。我们讲讲python，py和pyc其实本质上没有太大的区别，就和java的java和class，lua的lua和luac一样，没有解释器就不能运行。你可能会说，我也看到它们可以打包成exe和apk，确实但这是有代商榷的，究竟是把虚拟环境和程序一起打包进去(如cocos2dlua)，还是真的有静态编译技术就不得而知了。</p>
<h2 id="原生软件"><a href="#原生软件" class="headerlink" title="原生软件"></a>原生软件</h2><p>与虚拟机上的软件“一次编译(编写)处处允许”不同，原生软件的特点是“一次编写处处编译”，这是从开发者角度，我们先跳过，如果从用户的角度的话，还真就是各种后缀的不同了，而且不同平台还得下不同版本，还得分32位和64位等等。大部分用户对应用的印象还停留在“下载然后安装”，所以有时jar程序和py程序都得来一个exe才行，如minecraft就需要一个exe的启动器。不过这也没错，这才是原生软件。虚拟机上软件面向虚拟机运行，而原生软件则是面向操作系统运行的，注意不是硬件，后面我们会讲。我们举几个常见的系统说明一下，为什么不说苹果，才不是因为我没有苹果呢？</p>
<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>我们平常下载的exe安装包其实就是一个程序，只不过它将真正的程序打包以后，再加了一些用于配置的代码，如配置安装路径，修改注册表，创建快捷方式等，最重要的还是解压数据到指定路径。当然作者其实并不喜欢这种程序，而喜欢portable版，俗称绿色版或免安装版，至少这样可以对软件污染的范围有所控制，像有些软件拿管理员身份安装，谁知道它干了什么。一个标准的windows原生程序包括可执行文件，动态库和资源文件，其实基本所有软件都是这样的模式，目前看来是不可取代的。资源文件是一种统称，包括配置文件，媒体资源和软件自带的一些格式资源，因为它们多而杂，而且不是我们需要关注的，所以统称为一类就行了。在windows上，动态库是dll，可执行文件是exe，exe和dll才是我们的程序，exe是程序的入口。</p>
<h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><p>在linux上，依据不同的发行版本安装包的种类确实还挺多的，如ubuntu的deb(本质来自于debian发行版)，不过作为linux爱好者，更喜欢<code>apt install *</code>来安装软件，软件之所以有一个安装过程最大原因还是省去了用户繁琐配置的过程。linux程序只有一种，有可执行权限和elf文件头的文件，这是可执行文件，动态库则是so为后缀，放在“/usr/lib”之类路径下，当然还能通过配置来修改增加动态库路径就是了。在ubuntu下有一个应用列表，它实际就是一个可被桌面识别的配置文件，指向安装过的某个可执行文件，它路径配置比较自由。</p>
<h3 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h3><p>最后再说一说安卓吧，安卓的可执行文件是安装包(本质zip)里面的dex，这是一种类似jar的文件，但它运行在google自己研究的dalvik虚拟机上，可以兼容大部分javaAPI，对于引用的库，除了androidframework，都会被打包进dex，而桌面则是通过软件的配置来构造Intent(用于androidActivity跳转的类)，来执行相应的程序。安卓天生是linux，所以安卓提供native技术(实际上与java的jni无异)，可以在dex里调用动态库so的函数。所以对于安卓，软件=dex(可执行文件)+so(动态库)。对于linux，软件=有可执行权限的文件+so。对于windows，软件=exe+dll。有关动态库，还得提一嘴的是，它并非必需是在程序的，此时软件使用的是系统的动态库。为什么要说原生软件是面向系统的，就是因为它们离不开系统动态库。</p>
<h1 id="跨平台的难处"><a href="#跨平台的难处" class="headerlink" title="跨平台的难处"></a>跨平台的难处</h1><p>对于虚拟机上软件，只要官方虚拟机哪里有，哪里就能运行，并没有考虑跨平台的必要，这是提供方需考虑的，当然不排除第三方移植就是了。而对于原生软件，难点主要有俩，一是系统SDK(开发工具包)，二是硬件差异。</p>
<h2 id="系统SDK"><a href="#系统SDK" class="headerlink" title="系统SDK"></a>系统SDK</h2><p>原生软件是面向系统的，而非面向硬件，如果和我说汇编，我笑而不语。特别是对于闭源系统，我们离不开官方提供的SDK，就算开源也没谁会闲着开发再开发一套工具，嗯，话说GUN套件到底算什么。对于Windows，我们需要WindowsSDK，不过它基本是直接和Visual系列绑定的就是了，windows官方提供了不少编程语言如Basic，C/C++，C#，F#等，不过用得多的都是C系列就是了，谁让基本好多系统都支持C系列语言，至于为什么，我也不知道。这里还需要指出C#编译出的软件本质也属于虚拟机上程序，它依赖于.net运行时环境，只不过在windows里正好有，就好像原生环境一样。对于Android，我们需要AndroidSDK，早期没有AndroidStudio的时候，靠的是有扩展能力的编辑器(如eclipse)或者直接使用SDK中的命令程序，反正挺麻烦的，所以集成开发环境(IDE)则么也比命令行舒服太多了。对于苹果系列(包括mac和iphone)使用的是Xcode，因为没用过，所有不知道，直接跳过。最惨的或许是我们的linux了，没有IDE，只有GUN套件的gcc和g++，不过也正应如此我们才能更加深入的理解操作系统原理。接下来，我们的平台都是安卓和linux了，可别在意哦。  </p>
<h2 id="硬件差异"><a href="#硬件差异" class="headerlink" title="硬件差异"></a>硬件差异</h2><p>对于SDK差异，克服其实并不是很困难，如linux，window和mac有着不同的窗口创建API，但可以通过glfw框架简单的统一起来，它们主要表现在媒体方面，而基础操作的话，即标准C/C++库，则都是一样的，注意只是提供的API相同，编译后的结果是不同的。所以我们可以发现跨平台的C库基本都是媒体库如Qt，SDL，GTK等，我们需要注意跨平台C库和C库的区别，后者基于标准C/C++库实现，基本无平台差异性。这部分用于区分不同的桌面平台，而真正的难题在于硬件的差异，而其中问题最大的是显示，对于声音键盘等都比较同质化，而CPU的话虽然架构有所差异，但还是离不开冯诺依曼结构，显示才是最大的问题，这也是平台端与手机端较难对接的原因。你觉得只是屏幕变小那么简单？桌面端有窗口系统得益于巨大的屏幕，所以比例的问题并不是很大，但手机因为屏幕小，只能全屏，不同手机分辨率不同，或许这个开源安卓太多发行版有关吧，显示问题就出来了，如果是等比放缩的话其实观感影响不大，但拉伸还是看得挺难受的，所以以前安卓开发准备drawable是时候有好多分辨率，属实难受，不过现在大多基于框架(如游戏引擎)，提供分辨率适配功能。但难以跨平台终究还是两方面原因，一是确实硬件不行，二是懒和利益问题。对于前者主要表现在手机与桌面端的高端游戏上(有光追，体积雾等需要高端显卡的游戏)，低端游戏移植还是挺多的，这就涉及第二方面中的懒了，如懒得在安卓再设计一套UI，如果是逻辑控制，数据处理等方面可以靠C系语言的强大跨平台编译性，而UI才是最麻烦的东西，涉及流程复杂，像没有键盘的安卓还需要虚拟键盘，还有很强的平台相关性，这也是为什么MVC设计如此重要，如果单纯看绘图的话，勉强还有opengl，但原始积累的控件才是很麻烦的事。为什么大部分商业软件并没在linux上发行，这就与利益问题相关了，比如linux的开源协议，所以我们使用的linux软件基本都是开源免费的。</p>
<h1 id="一个软件的运行过程"><a href="#一个软件的运行过程" class="headerlink" title="一个软件的运行过程"></a>一个软件的运行过程</h1><p>在linux下可以通过<code>strace *</code>来查看软件的运行过程  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p1.png" class="">  
<p>这里的每一行都是一个系统调用(如execve,mmap)等，括号内是参数，等号后是执行状态，0表示正常，不过实际上这是有问题的，mkdir本身是系统调用，是在linux内核里面的，安卓确实有，但Termux只是个模拟软件没有权限调用，实际只能模拟一个类似的实现  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p2.png" class="">  
<p>这里的time也是一个系统调用，strace无法跟踪，所以我们还是举一个简单的helloworld比较合适  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p3.png" class="">  
<p>输出太长了，关键的其实就只要下面的这一句<code>write(1, &quot;Hello world!&quot;, 12Hello world!)</code>作者虽然学过操作系统原理，但真的实践的话还是差距太大了。我们看到execve感觉这样程序应该已经执行完了才对，但linux的程序实际都要依赖于我们当前的shell来运行，我们的a.out虽说是程序，但对于CPU而言是有杂质的，其次它并不在内存里(通俗讲是运行内存)，而在外存里CPU不能直接运行。mmap是内存映射，主要将代码拷贝到内存里，这就可以理解execve实际是用来解析可执行文件的，mprotect则是给程序分配内存用的防止内存溢出，prctl进程操作等等，我们直接说结论吧，其实只有纯正的命令行，它是显卡的一个运行状态(linux下Ctrl+Alt+F1切换)(除非你知道在做什么否则别这样)，我们才能看到一个程序真正的运行过程，我们实际使用的shell都是桌面进程的子进程，内部有许多封装和状态的模拟，早就离教材里的情况有十万八千里了，C程序的运行我之前在lua分析里讲过，进程实际是就是一段内存，有四个部分堆内存，代码段，栈内存，全局变量。而这些东西的建立与运行过程都是通过系统调用来实现的，所以我说过编程都是面向系统的。这时你或许要和我理论汇编了，确实我得讲一下这个东西了，C程序的编译阶段就包括汇编的过程，比如我们Helloworld的汇编代码如下  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p4.png" class="">  
<p>一句代码比较显眼<code>bl      printf</code>，也就是这里并没有完全实现输出，还是得靠其它函数实现，我们看看它的源码吧(来自glibc)…额，太复杂了，不过总之就是它依赖于系统调用实现的[说实话，有点破防了，以前学了操作系统原理，就想着这自己写一个操作系统，也曾跟着教程一步步来，但到后面我都不知道这样做的意义在哪，花费如此多的时间，完成度还不如很久以前的dos系统，有些时候要考虑很多东西，而这些东西都是历史积累的结果，短时间内想要把这些全部理解实在太困难了，而且跟着做完以后，你会发现它仍然无法适应如今的情况，也就是它真的只能用来学习，除非能摆脱如今的计算机架构有所创新，否则再写一个与如今系统差不多有又许多问题的系统，根本没有意义，就是兼容C也毫无意义，那时我才明白基于linux内核并非什么丢脸的事，以前我还十分看不起那些基于linux的手机系统呢，唉，过去的事，提提就过去吧]。这时或许你会说，我用汇编实现helloworld的代码应该是这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">data SEGMENT</span><br><span class="line">	msg DB &#x27;Hello, world.$&#x27;</span><br><span class="line">	data ENDS</span><br><span class="line">code SEGMENT</span><br><span class="line">	ASSUME CS:code,DS:data</span><br><span class="line">  start:MOV AX,data</span><br><span class="line">	MOV DS,AX</span><br><span class="line">	lea dx,msg</span><br><span class="line">	mov ah,9h</span><br><span class="line">	int 21h</span><br><span class="line">	MOV AX,4C00h</span><br><span class="line">	INT 21h</span><br><span class="line">	code ENDS</span><br><span class="line">  END start</span><br></pre></td></tr></table></figure>
<p>其中重要的部分是<code>int 21h</code>，有些人也喜欢用<code>int 0x80</code>，后者是纯粹的系统调用的写法，编译器会”理解性”的帮你解释，而前者则是真正的中断服务，中断是CPU与其它设备交流的核心指令，<code>int 21h</code>是dos提供的字符中断例程，与之类似的还有<code>int 10h</code>是dos提供的图形中断例程，有没有发现即使汇编你还是离不开系统，如果你让它在你的系统上编译肯定是这样的，dosbox综究还只是个模拟器。不过int指令确实是CPU与其它硬件交流的核心，好了直接跳到重点吧，CPU的大多指令都是逻辑控制与计算和对内存的控制，这与C的基本语句都是类似的，而复杂的与硬件交流的指令如int,in,out等，我们则会通过封装在系统调用里的库来实现的，操作系统真正重要的其实就是这一部分，而封装的过程则是驱动的编写，linux内核就是宏内核，它把许多与硬件交流的部分全封装起来，如进程管理(本质就是内存管理)，并将系统调用外露出来，当然还要封装一层C/C++接口来方便编程就是了，最后套个shell就可以形成一个操作系统了。操作系统重要的作用就是保护硬件，所以特别关注int指令还是可以理解的。最后我们应该可以理解一个软件真正的运行过程了，看看下面这个图吧。  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p5.png" class="">  
<p>演不下去了，这还是最简单的shell，实际的系统更加复杂，不过比我们需要的超出太多了，所以不讲了，笔者在底层虽说有一定理解，但还是离实际差太远了，希望谅解作者的水平。</p>
<h1 id="重识C语言"><a href="#重识C语言" class="headerlink" title="重识C语言"></a>重识C语言</h1><p>或许你会疑惑一个问题，操作系统是用C写的，但C又是在操作系统上编译的，好像是个死循环，实际上C语言的GUN套件包括编译器也是C写的。实际上这都是历史积累的结果，这个从python就很好理解，python的原始解释器是CPython，但后来又有一个用python写的解释器PyPy，与python不同C是可以编译为二进制文件的，它的运行依赖于CPU而不是解释器，所以一旦有了一个原始的程序，比如通过烧录，它有编译C的功能，这样在通过C写一个新的编译器，编译为CPU上程序即可，这样以后都用这个就行了，不过这不是重点。我们都知道C语言的编译分四部:预处理，编译，汇编和链接。<br>其中的枢纽是函数，函数始终贯穿四个步骤，我们并没有提C++并非说它没有讨论的必要，只是C++终究只是为了引入一些现代思想(面向对象，内存保护等)而形成的C的超集，理解底层还是得靠C。在预处理中，主要有两大作用，一是选择需要编译的代码(主要用于跨平台编译)，二是声明需要的函数和结构体，编译则是将C语言转化为适应于相应系统的汇编代码，汇编将汇编代码转为二进制文件，链接则是将申明的函数连接到相应的实现位置。这些都挺好理解，但为什么说枢纽是函数，在我们开发过程中，很容易发现对于逻辑控制和数据处理这类CPU擅长的事，不会用到任何函数，它们是可以直接汇编为机器指令。而函数封装的则是一些本身非CPU的直接性指令，如输出语句，这时就需要引入外部的库。在linux里，无特别配置的话，头文件的默认路径是<code>/usr/include</code>或<code>/usr/local/include</code>，里面除了C标准库，我们发现还有一些比较注目的如linux和sys，如果安装过桌面系统的就还有gl、x11之类的图形框架。前面这两个一般的开发者(如我)基本估计都没有用过，实际上系统调用就申明在<code>linux/syscalls.h</code>里面，只是一些名称对应数字的宏，实际上许多驱动的相关函数也在这个目录里面，这类东西其实与我差距还是太远了。我们再来认识一下C语言吧，C其实只是汇编语言上的一层不太复杂的抽象，汇编嘛，只不过是机器指令的映射罢了，对于无危险性的行为直接编译即可，而较危险(主要是与硬件的交互)则主要封装在系统里，然后通过向外提供的接口来调用。至此其实对所谓的操作系统应该有大概的理解了，那就是硬件管理，通俗讲就是驱动程序。不过嘛，除了咱们的linux，准确来说是内核吧，上层还是封装了许多东西才有我们的操作系统，想想我们曾学过的操作系统原理，不知为何总是对不上windows之类的系统。说太多了，其实我觉得C之所以一直占据底层，估计是很多人懒得写编译器罢了，要么就是原始的软件生态太难超过了，比如go之类的语言，编译结果一样是可以依赖CPU运行的。其实用过GUN套件编译C的人大多对这样应该都是很了解的了，要不就当我水点字数吧。</p>
<h1 id="从安卓开发看安卓"><a href="#从安卓开发看安卓" class="headerlink" title="从安卓开发看安卓"></a>从安卓开发看安卓</h1><p>开发者在一部安卓手机上有多大的控制权，实际的意思是软件的控制权有多大，不过我们得考虑一种叫root的东西，默认没有就行了。这要从安卓的框架说起，从下到上分为为4层，linux内核层，系统运行层，应用框架层，应用层。一般的用户只是使用软件，停留在应用层，而安卓的开发者可在应用框架层使用java，在系统运行层使用C/C++再通过回调返回结果到应用层。这些其实都不重要，重要的是它是linux内核的，重要的是我们可以通过NDK使用内核外露的C库，没法控制的大头在于权限管理。在linux里面一个程序(如ls)要运行必需要有可执行权限，但是安卓应用并没有权限管理的功能，准确来说是linux层的那种权限管理，不过这是针对一般应用，如果是系统应用或root应用就别考虑了，这除了找漏洞还真没啥办法，已经超出了我的能力范围。回到正题，其实对于一个应用它能完全控制的路径如下(不过依据不同的发行系统可能稍有偏差)  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p6.png" class="">  
<p>dex+lib属于程序的核心部分，然后还有apk的备份和缓存区，外部的嘛没什么好说的，重点来了，那个文件夹就是6.71GB的那个，不过这里应该是存在软链接的，比如在Termux下的路径是这样的  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p7.png" class="">  
<p>我猜<code>/data/data</code>和<code>/data/user/0</code>应该是链接，没root我也不能肯定啊。这时我们还有一个值得注意的是u0_a166这个用户和用户组，这个实际就是系统分配给软件的，看来终究还是得适应linux内核。这里面的文件，shared_prefs是安卓在java层有一个SharedPreferences存储的位置，databases虽然这里没有但它也是java层提供的sqlite存储的位置，cache缓存对于这种东西我都是保持沉默的，files是软件随便存储的私人空间通过“openFile*”即可获得相应的流，而这也就是我们实现一个类linux的核心据点了。有人觉得外存不行吗？确实不行，你看  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p8.png" class="">  
<p>除了root用户，我们没有任何权限，你可能会说不对啊，只要在Manifest.xml里申明permission的话可以写入文件啊。其实我们可能需要稍微讲讲权限管理定位本质是什么，安卓层的咱不讲，我们讲linux层，你有没有发现关于权限的操作往往于硬件相关，这意味着我们需要通过函数调用来实现相关操作，最简单的实现权限管理的方法就是这这个函数里加上权限的判断，实际上我们可能还得讲进程管理的问题，实际上在linux里一个用户对应一个进程或者说一个shell，我们通过shell实现相应操作这个shell实际已经通过登陆的用户拥有着权限标识，但是要行使权限还是得靠系统调用，系统自然就可以根据你的权限标识来判断操作是否继续执行，简单的权限管理就可以实现了。这也解释了，我们之前为什么要这么关心文件和权限的问题，因为linux系统权限管理的核心就在这里，这也确立了files文件的重要性。对于更加细致的就不讲了吧，本来就有很多相关作品，再讲一遍就太浪费时间了。文件为何如此重要，这来源于liunx万物皆文件的思想，比如/dev，/tmp，/run等文件，linux实际上还可以通过修改/proc下的文件来对进程中的变量操作，不过都是root才有的权限就是了。为什么会认为Termux是伪终端，因为Termux只实现了/home和/usr目录，而内核实际上还是依赖安卓自身的内核，同时useradd之类的用户管理命令Termux也是做不到的，真的学linux的话，Termux并不是一个好的工具，但它对开发者而言却是一个手机利器(比如我)。</p>
<h1 id="Termux实现的可能性"><a href="#Termux实现的可能性" class="headerlink" title="Termux实现的可能性"></a>Termux实现的可能性</h1><p>讲了这么就底层与安卓的东西，终于可以来讲Termux该怎么实现了，首先我们要明确到底实现哪些功能，比如用户管理显然不行，超应用范围的文件操作也是不行的，其实有些是没必要的，在files文件下Termux自己其实就像一个root用户可以任意修改读写权限，虽然范围有所限制，但子树还是能和原来的树有相似功能的，我们要完成的事情实际只要一个，在files里执行C编译后的程序，实际得使用NDK来编译，但我们可以使用Termux的GCC来近似达到目的，一旦说明了上述功能的可能性，实际上就可以让许多C程序在Termux上运行了，只要利用安卓的界面，图形界面其实也是可以实现的，比如国改的UTermux或Aidlearning，它们的实现都是类似的，不过我们先从基础的开始。光说不练假本事，接下来我们写一个小项目，执行flies下的HelloWorld并把结果输出到界面上。先随便写一个界面  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p9.png" class="">  
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p10.png" class="">  
<p>然后将我们的可执行文件拷贝到软件目录下(这里是外置内存卡，别忘了加权限)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick1</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        String fromFile = <span class="string">&quot;a.out&quot;</span>;</span><br><span class="line">        String toFile = <span class="string">&quot;a.out&quot;</span>;</span><br><span class="line">        String fromFullPath = Environment.getExternalStorageDirectory().getAbsolutePath()</span><br><span class="line">            + <span class="string">&quot;/&quot;</span> + fromFile;</span><br><span class="line">        String toFullPath = getFilesDir()</span><br><span class="line">            + <span class="string">&quot;/&quot;</span> + toFile;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//输入流</span></span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(fromFullPath);</span><br><span class="line">            <span class="comment">//输出流</span></span><br><span class="line">            FileOutputStream fos = openFileOutput(toFile, MODE_WORLD_WRITEABLE);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> length;</span><br><span class="line">            <span class="keyword">while</span>((length = fis.read(data))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(data, <span class="number">0</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            fis.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            </span><br><span class="line">            log.append(<span class="string">&quot;成功将&quot;</span></span><br><span class="line">                + fromFullPath</span><br><span class="line">                + <span class="string">&quot;拷贝至&quot;</span></span><br><span class="line">                + toFullPath</span><br><span class="line">                + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            log.append(<span class="string">&quot;未找到文件!\n&quot;</span>);</span><br><span class="line">            log.append(e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            log.append(<span class="string">&quot;IO异常!\n&quot;</span>);</span><br><span class="line">            log.append(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后是执行的核心代码(其实挺简单的)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick2</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        String toFile = <span class="string">&quot;a.out&quot;</span>;</span><br><span class="line">        String toFullPath = getFilesDir()</span><br><span class="line">            + <span class="string">&quot;/&quot;</span> + toFile;</span><br><span class="line">            </span><br><span class="line">        File file = <span class="keyword">new</span> File(toFullPath);</span><br><span class="line">        <span class="keyword">boolean</span> success = file.setExecutable(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(!success)</span><br><span class="line">            log.append(<span class="string">&quot;Permission Denied!\n&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//保存输出</span></span><br><span class="line">            InputStream is;</span><br><span class="line">            </span><br><span class="line">            Process proc = runtime.exec(file.getAbsolutePath());</span><br><span class="line">            <span class="keyword">if</span>(proc.waitFor() != <span class="number">0</span>) &#123;</span><br><span class="line">                log.append(<span class="string">&quot;运行错误 exit code=&quot;</span>+proc.exitValue()+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                is = proc.getErrorStream();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                is = proc.getInputStream();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> length;</span><br><span class="line">            <span class="keyword">while</span>((length = is.read(data))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                log.append(<span class="keyword">new</span> String(data, <span class="number">0</span>, length));</span><br><span class="line">            &#125;</span><br><span class="line">            log.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.append(<span class="string">&quot;IO异常!\n&quot;</span>);</span><br><span class="line">            log.append(e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            log.append(<span class="string">&quot;执行中断!\n&quot;</span>);</span><br><span class="line">            log.append(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后编译测试一下(a.out已经用Termux编译后提前准备好了)  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p11.png" class="">  
<p>嗯，完美执行了……感觉有点不够，真的有这么简单嘛？是的确实就是这么简单，安卓实际已经封装了不少方法，只不过这种API一般用得比较少，开发者就没怎么注意过。实际上，runtime除了exec执行命令外还有许多方法，如loadLibrary可以载入动态库，traceInstructions进行跟踪等。实际上，内核这东西安卓已经有了，我们做的不过是一层封装罢了。你问我，我前面讲这么多的意义在哪？当然是更好的理解API啦，有时API用起来难，实际难在不理解背后的原理。</p>
<h1 id="看看Termux源码"><a href="#看看Termux源码" class="headerlink" title="看看Termux源码"></a>看看Termux源码</h1><p>最后我们稍微速览一下Termux的源码吧，<a target="_blank" rel="noopener" href="https://github.com/termux/termux-app/">这里是地址</a>。嗯，才4M左右的内存，不对啊记得明明安装包都有80M左右，赶快拆包看看。  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p12.png" class="">  
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p13.png" class="">  
<p>好家伙，bootstrap不是个Web框架吗？开玩笑啦，其实这个只是Termux运行基本库，主要是用来兼容安卓下没有的linux的一些库，还有一些基本命令。Termux编译了四个不同的架构，加起来正好80M左右，好了回到正题  </p>
<img src="/archives/2021-12-22-Termux%E5%8E%9F%E7%90%86/p14.png" class="">  
<p>我们看到源码分三部分来写，emulator应该是核心部分，view应该是界面，app的话应该是用来整合成一个应用的。在app的Manifest里面我们看到了三个Activity，至于还有一个别名Activity就别管了，TermuxActivity即是主界面，(注意View是界面不是Activity，两者有一定区别，所以Activity在app里而不在view里)。另外两个TermuxHelpActivity和TermuxFileReceiverActivity，这是啥，算了没见过不懂，还是先看看源码吧。嗯嗯，在TermuxActivity里可以看到这个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">    ***</span><br><span class="line">    mTerminalView = findViewById(R.id.terminal_view);</span><br><span class="line">    mTerminalView.setOnKeyListener(<span class="keyword">new</span> TermuxViewClient(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    mTerminalView.setTextSize(mSettings.getFontSize());</span><br><span class="line">    mTerminalView.setKeepScreenOn(mSettings.isScreenAlwaysOn());</span><br><span class="line">    mTerminalView.requestFocus();</span><br><span class="line">    ***</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mTermuxView是TermuxView的实例对象，它定义在view里面，是Termux的主要界面shell部分的内容。我们继续看，在TermuxView里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TerminalView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    ***</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCheckIsTextEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ***</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputConnection <span class="title">onCreateInputConnection</span><span class="params">(EditorInfo outAttrs)</span> </span>&#123;</span><br><span class="line">        ***</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseInputConnection(<span class="keyword">this</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">finishComposingText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ***</span><br><span class="line">                sendTextToTerminal(getEditable());</span><br><span class="line">                getEditable().clear();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitText</span><span class="params">(CharSequence text, <span class="keyword">int</span> newCursorPosition)</span> </span>&#123;</span><br><span class="line">                ***</span><br><span class="line">                Editable content = getEditable();</span><br><span class="line">                sendTextToTerminal(content);</span><br><span class="line">                content.clear();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ***</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">sendTextToTerminal</span><span class="params">(CharSequence text)</span> </span>&#123;</span><br><span class="line">                stopTextSelectionMode();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> textLengthInChars = text.length();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; textLengthInChars; i++) &#123;</span><br><span class="line">                    <span class="keyword">char</span> firstChar = text.charAt(i);</span><br><span class="line">                    <span class="keyword">int</span> codePoint;</span><br><span class="line">                    <span class="keyword">if</span> (Character.isHighSurrogate(firstChar)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (++i &lt; textLengthInChars) &#123;</span><br><span class="line">                            codePoint = Character.toCodePoint(firstChar, text.charAt(i));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// At end of string, with no low surrogate following the high:</span></span><br><span class="line">                            codePoint = TerminalEmulator.UNICODE_REPLACEMENT_CHAR;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        codePoint = firstChar;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> ctrlHeld = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (codePoint &lt;= <span class="number">31</span> &amp;&amp; codePoint != <span class="number">27</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (codePoint == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                            <span class="comment">// The AOSP keyboard and descendants seems to send \n as text when the enter key is pressed,</span></span><br><span class="line">                            <span class="comment">// instead of a key event like most other keyboard apps. A terminal expects \r for the enter</span></span><br><span class="line">                            <span class="comment">// key (although when icrnl is enabled this doesn&#x27;t make a difference - run &#x27;stty -icrnl&#x27; to</span></span><br><span class="line">                            <span class="comment">// check the behaviour).</span></span><br><span class="line">                            codePoint = <span class="string">&#x27;\r&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// E.g. penti keyboard for ctrl input.</span></span><br><span class="line">                        ctrlHeld = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">switch</span> (codePoint) &#123;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">31</span>:</span><br><span class="line">                                codePoint = <span class="string">&#x27;_&#x27;</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">30</span>:</span><br><span class="line">                                codePoint = <span class="string">&#x27;^&#x27;</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">29</span>:</span><br><span class="line">                                codePoint = <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> <span class="number">28</span>:</span><br><span class="line">                                codePoint = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                codePoint += <span class="number">96</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    inputCodePoint(codePoint, ctrlHeld, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分是用来监听输入法输入的代码，<code>void sendTextToTerminal(CharSequence text) &#123;</code>里面的text即是我们一次输入的内容，对于有些字符稍作处理后，再把任务交给<code>inputCodePoint(codePoint, ctrlHeld, false);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inputCodePoint</span><span class="params">(<span class="keyword">int</span> codePoint, boolean controlDownFromEvent, boolean leftAltDownFromEvent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG_KEY_EVENTS) &#123;</span><br><span class="line">            Log.i(EmulatorDebug.LOG_TAG, <span class="string">&quot;inputCodePoint(codePoint=&quot;</span> + codePoint + <span class="string">&quot;, controlDownFromEvent=&quot;</span> + controlDownFromEvent + <span class="string">&quot;, leftAltDownFromEvent=&quot;</span></span><br><span class="line">                + leftAltDownFromEvent + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTermSession == null) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> boolean controlDown = controlDownFromEvent || mClient.readControlKey();</span><br><span class="line">        <span class="keyword">final</span> boolean altDown = leftAltDownFromEvent || mClient.readAltKey();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mClient.onCodePoint(codePoint, controlDown, mTermSession)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (controlDown) &#123;</span><br><span class="line">            <span class="keyword">if</span> (codePoint &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; codePoint &lt;= <span class="string">&#x27;z&#x27;</span>) &#123;</span><br><span class="line">                codePoint = codePoint - <span class="string">&#x27;a&#x27;</span> + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; codePoint &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line">                codePoint = codePoint - <span class="string">&#x27;A&#x27;</span> + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27; &#x27;</span> || codePoint == <span class="string">&#x27;2&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;[&#x27;</span> || codePoint == <span class="string">&#x27;3&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">27</span>; <span class="comment">// ^[ (Esc)</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;\\&#x27;</span> || codePoint == <span class="string">&#x27;4&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">28</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;]&#x27;</span> || codePoint == <span class="string">&#x27;5&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">29</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;^&#x27;</span> || codePoint == <span class="string">&#x27;6&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">30</span>; <span class="comment">// control-^</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;_&#x27;</span> || codePoint == <span class="string">&#x27;7&#x27;</span> || codePoint == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// &quot;Ctrl-/ sends 0x1f which is equivalent of Ctrl-_ since the days of VT102&quot;</span></span><br><span class="line">                <span class="comment">// - http://apple.stackexchange.com/questions/24261/how-do-i-send-c-that-is-control-slash-to-the-terminal</span></span><br><span class="line">                codePoint = <span class="number">31</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint == <span class="string">&#x27;8&#x27;</span>) &#123;</span><br><span class="line">                codePoint = <span class="number">127</span>; <span class="comment">// DEL</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (codePoint &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// Work around bluetooth keyboards sending funny unicode characters instead</span></span><br><span class="line">            <span class="comment">// of the more normal ones from ASCII that terminal programs expect - the</span></span><br><span class="line">            <span class="comment">// desire to input the original characters should be low.</span></span><br><span class="line">            <span class="keyword">switch</span> (codePoint) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x02DC</span>: <span class="comment">// SMALL TILDE.</span></span><br><span class="line">                    codePoint = <span class="number">0x007E</span>; <span class="comment">// TILDE (~).</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x02CB</span>: <span class="comment">// MODIFIER LETTER GRAVE ACCENT.</span></span><br><span class="line">                    codePoint = <span class="number">0x0060</span>; <span class="comment">// GRAVE ACCENT (`).</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x02C6</span>: <span class="comment">// MODIFIER LETTER CIRCUMFLEX ACCENT.</span></span><br><span class="line">                    codePoint = <span class="number">0x005E</span>; <span class="comment">// CIRCUMFLEX ACCENT (^).</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If left alt, send escape before the code point to make e.g. Alt+B and Alt+F work in readline:</span></span><br><span class="line">            mTermSession.writeCodePoint(altDown, codePoint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>显然这个方法处理完ctrl就交给mTermSession来处理alt了，它是TerminalSession的实例对象，但它是在TermuxActivity里面实例化的，并通过view的attackSession来绑定，总之知道它是处理层的东西就行了，我们去看看吧，它在emulator模块里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TerminalSession</span> <span class="title">extends</span> <span class="title">TerminalOutput</span> &#123;</span></span><br><span class="line">@<span class="function">Override</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(byte[] data, <span class="keyword">int</span> offset, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mShellPid &gt; <span class="number">0</span>) mTerminalToProcessIOQueue.write(data, offset, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Write the Unicode code point to the terminal encoded in UTF-8. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeCodePoint</span><span class="params">(boolean prependEscape, <span class="keyword">int</span> codePoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (codePoint &gt; <span class="number">1114111</span> || (codePoint &gt;= <span class="number">0xD800</span> &amp;&amp; codePoint &lt;= <span class="number">0xDFFF</span>)) &#123;</span><br><span class="line">            <span class="comment">// 1114111 (= 2**16 + 1024**2 - 1) is the highest code point, [0xD800,0xDFFF] is the surrogate range.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid code point: &quot;</span> + codePoint);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> bufferPosition = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (prependEscape) mUtf8InputBuffer[bufferPosition++] = <span class="number">27</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (codePoint &lt;= <span class="comment">/* 7 bits */</span><span class="number">0b1111111</span>) &#123;</span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) codePoint;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint &lt;= <span class="comment">/* 11 bits */</span><span class="number">0b11111111111</span>) &#123;</span><br><span class="line">            <span class="comment">/* 110xxxxx leading byte with leading 5 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b11000000</span> | (codePoint &gt;&gt; <span class="number">6</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | (codePoint &amp; <span class="number">0b111111</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePoint &lt;= <span class="comment">/* 16 bits */</span><span class="number">0b1111111111111111</span>) &#123;</span><br><span class="line">			<span class="comment">/* 1110xxxx leading byte with leading 4 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b11100000</span> | (codePoint &gt;&gt; <span class="number">12</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | ((codePoint &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0b111111</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | (codePoint &amp; <span class="number">0b111111</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* We have checked codePoint &lt;= 1114111 above, so we have max 21 bits = 0b111111111111111111111 */</span></span><br><span class="line">			<span class="comment">/* 11110xxx leading byte with leading 3 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b11110000</span> | (codePoint &gt;&gt; <span class="number">18</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | ((codePoint &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b111111</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | ((codePoint &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0b111111</span>));</span><br><span class="line">			<span class="comment">/* 10xxxxxx continuation byte with following 6 bits */</span></span><br><span class="line">            mUtf8InputBuffer[bufferPosition++] = (byte) (<span class="number">0b10000000</span> | (codePoint &amp; <span class="number">0b111111</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        write(mUtf8InputBuffer, <span class="number">0</span>, bufferPosition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会传入mTerminalToProcessIOQueue来处理相关事务，它是一个byte队列，用来将terminal数据传入我们进程的数据结构，然后我们的读取线程在这里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeEmulator</span><span class="params">(<span class="keyword">int</span> columns, <span class="keyword">int</span> rows)</span> </span>&#123;</span><br><span class="line">        mEmulator = <span class="keyword">new</span> TerminalEmulator(<span class="keyword">this</span>, columns, rows, <span class="comment">/* transcript= */</span><span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] processId = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        mTerminalFileDescriptor = JNI.createSubprocess(mShellPath, mCwd, mArgs, mEnv, processId, rows, columns);</span><br><span class="line">        mShellPid = processId[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> FileDescriptor terminalFileDescriptorWrapped = wrapFileDescriptor(mTerminalFileDescriptor);</span><br><span class="line">        ***</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="string">&quot;TermSessionOutputWriter[pid=&quot;</span> + mShellPid + <span class="string">&quot;]&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                <span class="keyword">try</span> (FileOutputStream termOut = <span class="keyword">new</span> FileOutputStream(terminalFileDescriptorWrapped)) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> bytesToWrite = mTerminalToProcessIOQueue.read(buffer, <span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">if</span> (bytesToWrite == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">                        termOut.write(buffer, <span class="number">0</span>, bytesToWrite);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        ***</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>JNI是native方法的封装类，对应我们之前看到的libtermux.so，看样子它最终是用C来实现的，不过对于安卓java与C没太大差别。我们换到jni，看看termux.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_subprocess</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">char</span> <span class="keyword">const</span>* cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">char</span> <span class="keyword">const</span>* cwd,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">char</span>* <span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">char</span>** envp,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span>* pProcessId,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint rows,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint columns)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ptm = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (ptm &lt; <span class="number">0</span>) <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Cannot open /dev/ptmx&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LACKS_PTSNAME_R</span></span><br><span class="line">    <span class="keyword">char</span>* devname;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">char</span> devname[<span class="number">64</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (grantpt(ptm) || unlockpt(ptm) ||</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LACKS_PTSNAME_R</span></span><br><span class="line">            (devname = ptsname(ptm)) == <span class="literal">NULL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            ptsname_r(ptm, devname, <span class="keyword">sizeof</span>(devname))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Cannot grantpt()/unlockpt()/ptsname_r() on /dev/ptmx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable UTF-8 mode and disable flow control to prevent Ctrl+S from locking up the display.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">tios</span>;</span></span><br><span class="line">    tcgetattr(ptm, &amp;tios);</span><br><span class="line">    tios.c_iflag |= IUTF8;</span><br><span class="line">    tios.c_iflag &amp;= ~(IXON | IXOFF);</span><br><span class="line">    tcsetattr(ptm, TCSANOW, &amp;tios);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Set initial winsize. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">sz</span> =</span> &#123; .ws_row = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) rows, .ws_col = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) columns &#125;;</span><br><span class="line">    ioctl(ptm, TIOCSWINSZ, &amp;sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        *pProcessId = (<span class="keyword">int</span>) pid;</span><br><span class="line">        <span class="keyword">return</span> ptm;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     ***</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jint JNICALL Java_com_termux_terminal_JNI_createSubprocess(</span><br><span class="line">        JNIEnv* env,</span><br><span class="line">        jclass TERMUX_UNUSED(clazz),</span><br><span class="line">        jstring cmd,</span><br><span class="line">        jstring cwd,</span><br><span class="line">        jobjectArray args,</span><br><span class="line">        jobjectArray envVars,</span><br><span class="line">        jintArray processIdArray,</span><br><span class="line">        jint rows,</span><br><span class="line">        jint columns)</span><br><span class="line">&#123;</span><br><span class="line">    ***</span><br><span class="line">    <span class="keyword">int</span> procId = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span>* cmd_cwd = (*env)-&gt;GetStringUTFChars(env, cwd, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span>* cmd_utf8 = (*env)-&gt;GetStringUTFChars(env, cmd, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">int</span> ptm = create_subprocess(env, cmd_utf8, cmd_cwd, argv, envp, &amp;procId, rows, columns);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, cmd, cmd_utf8);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, cmd, cmd_cwd);</span><br><span class="line">    ***</span><br><span class="line">    <span class="keyword">return</span> ptm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我看到<code>int ptm = open(&quot;/dev/ptmx&quot;, O_RDWR | O_CLOEXEC);</code>的时候，算了，我们实现的方式看来存在根本上的区别，我就说为什么每次运行Termux的时候通知栏有一个消不掉的东西(手机截不到屏)，这原来是系统的东西，我还以为是程序的东西。欸欸，有没有觉得很惊讶，是我孤陋寡闻了？嘿嘿，看我为什么做了这么多铺垫，意义不就来了嘛！至于“/dev/ptmx”嘛，它是linux内核自带的伪终端设备，看来android果然天生就是linux，好了，我们说过就是速览一下，看来也该结束了，你问我怎么实现的好像没说？我只能说补一补linux的知识吧。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BD%AF%E4%BB%B6/">软件</a><a class="post-meta__tags" href="/tags/%E7%BB%88%E7%AB%AF/">终端</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">逯晓零</div><div class="author-info__description">我喜欢简洁，仅此而已。</div></div><div class="card-info-data site-data is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.</span> <span class="toc-text">软件是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">虚拟机上软件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">原生软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows"><span class="toc-number">1.2.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux"><span class="toc-number">1.2.2.</span> <span class="toc-text">linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%8D%93"><span class="toc-number">1.2.3.</span> <span class="toc-text">安卓</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%9A%BE%E5%A4%84"><span class="toc-number">2.</span> <span class="toc-text">跨平台的难处</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9FSDK"><span class="toc-number">2.1.</span> <span class="toc-text">系统SDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E5%B7%AE%E5%BC%82"><span class="toc-number">2.2.</span> <span class="toc-text">硬件差异</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E8%BD%AF%E4%BB%B6%E7%9A%84%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">一个软件的运行过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E8%AF%86C%E8%AF%AD%E8%A8%80"><span class="toc-number">4.</span> <span class="toc-text">重识C语言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%E7%9C%8B%E5%AE%89%E5%8D%93"><span class="toc-number">5.</span> <span class="toc-text">从安卓开发看安卓</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Termux%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E6%80%A7"><span class="toc-number">6.</span> <span class="toc-text">Termux实现的可能性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9C%8B%E7%9C%8BTermux%E6%BA%90%E7%A0%81"><span class="toc-number">7.</span> <span class="toc-text">看看Termux源码</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/2023-10-01-%E6%9D%82%E8%B0%88%EF%BC%9A2023-10-01/" title="杂谈：2023.10.01">杂谈：2023.10.01</a><time datetime="2023-10-01T09:15:46.000Z" title="发表于 2023-10-01 17:15:46">2023-10-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/2023-09-03-%E6%88%91%E8%BF%98%E6%83%B3%E5%81%9A%E7%9A%84%E4%BA%8B/" title="我还想做的事">我还想做的事</a><time datetime="2023-09-02T23:41:56.000Z" title="发表于 2023-09-03 07:41:56">2023-09-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/archives/2023-07-27-%E9%AD%94%E7%BE%A4%E6%9C%88%E5%85%89/" title="魔群月光">魔群月光</a><time datetime="2023-07-27T07:34:21.000Z" title="发表于 2023-07-27 15:34:21">2023-07-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 逯晓零</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div></div></body></html>